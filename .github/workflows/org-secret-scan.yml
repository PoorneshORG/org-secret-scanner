name: Org-wide Secret Scan

on:
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout scanner repo
        uses: actions/checkout@v4

      - name: Generate GitHub App token
        uses: tibdex/github-app-token@v2
        id: app-token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_ORG_SCANS }}

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: List repositories
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh api orgs/PoorneshORG/repos --paginate \
            --jq '.[].clone_url' > repos.txt

          echo "Repositories found:"
          cat repos.txt

      - name: Scan repositories
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          mkdir results

          while read repo; do
            name=$(basename "$repo" .git)
            echo "=============================="
            echo "Scanning $name"
            echo "=============================="

            # Skip special repos
            if [ "$name" = ".github" ] || [ "$name" = "org-secret-scanner" ]; then
              echo "Skipping $name"
              continue
            fi
            
            owner_repo=$(echo "$repo" | sed 's|https://github.com/||; s|\.git$||')
            auth_repo="https://x-access-token:${GH_TOKEN}@github.com/${owner_repo}.git"
            
            git clone "$auth_repo" "$name"

            docker run --rm \
              --entrypoint sh \
              -v "$PWD/$name:/app" \
              -w /app \
              ghcr.io/poorneshorg/gitleaks:multiarch-1.0 \
              -c "git config --global --add safe.directory /app && \
                  gitleaks detect \
                    --source=/app \
                    --report-format=json \
                    --report-path=/app/gitleaks.json || true"

            if [ -f "$name/gitleaks.json" ]; then
              mkdir -p "results/$name"
              mv "$name/gitleaks.json" "results/$name/"
            fi

            rm -rf "$name"
          done < repos.txt

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: org-secret-scan-results
          path: results
